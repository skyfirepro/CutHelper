<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä—É–ª–æ–Ω–æ–≤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º—ã (Neumorphism) */
        body {
            font-family: sans-serif;
            background-color: #f0f0f0;
            transition: background-color 0.3s, color 0.3s;
            color: #333;
            margin: 0px 5px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            background-color: #f0f0f0;
            border-radius: 20px;
            box-shadow: 10px 10px 20px rgba(163, 163, 163, 0.4),
                -10px -10px 20px rgba(255, 255, 255, 0.8);
            width: 450px;
            transition: background-color 0.3s, color 0.3s;
            margin: 10px auto;
            padding: 20px;
            position: relative;
        }

        #themeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: #f0f0f0;
            border: none;
            padding: 10px 12px;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 5px 5px 10px rgba(163, 163, 163, 0.4), -5px -5px 10px rgba(255, 255, 255, 0.8);
            font-size: 18px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
        }

        .checkbox-container .form-input-checkbox {
            width: auto;
            margin: 0;
            box-shadow: none;
            min-height: 20px;
        }

        .checkbox-container .form-label {
            display: inline;
            margin-top: 0;
            font-weight: normal;
            cursor: pointer;
        }

        .main-title-link {
            margin-top: 15px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
            color: #007BFF;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }

        .main-title-link:hover {
            text-decoration: underline;
        }

        .text-underline {
            text-decoration: none;
            border-bottom: 1px solid currentColor;
            display: inline;
        }

        .underlined-title {
            display: block;
            font-size: 1.17em;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 15px;
        }

        .correction-label {
            font-size: 1.17em;
            margin-top: 25px;
            margin-bottom: 5px;
        }

        .form-label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            box-sizing: border-box;
            border: none;
            border-radius: 10px;
            background-color: #f0f0f0;
            color: #333;
            box-shadow: inset 5px 5px 10px #babecc, inset -5px -5px 10px #fff;
            transition: box-shadow 0.3s, border-color 0.3s;
        }

        .form-input.input-error {
            border: 1px solid #dc3545;
            box-shadow: inset 2px 2px 5px #dc354566, inset -2px -2px 5px #dc354566;
        }

        .form-input:disabled,
        .form-select:disabled {
            background-color: #e0e0e0;
            color: #999;
            box-shadow: inset 2px 2px 5px #babecc, inset -2px -2px 5px #fff;
            cursor: default;
            border-color: transparent;
        }

        .form-input:not(:disabled),
        .form-select:not(:disabled) {
            cursor: text;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            margin-bottom: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 5px 5px 10px rgba(163, 163, 163, 0.4), -5px -5px 10px rgba(255, 255, 255, 0.8);
        }

        .calculate-btn:hover {
            background-color: #0056b3;
        }

        .share-btn {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            margin-bottom: 10px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 5px 5px 10px rgba(163, 163, 163, 0.4), -5px -5px 10px rgba(255, 255, 255, 0.8);
            transition: background-color 0.3s;
            display: none;
        }

        .share-btn:hover {
            background-color: #1e7e34;
        }


        .reset-btn {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            margin-bottom: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 5px 5px 10px rgba(163, 163, 163, 0.4), -5px -5px 10px rgba(255, 255, 255, 0.8);
            transition: background-color 0.3s;
        }

        .reset-btn:hover {
            background-color: #c82333;
        }

        .result-title {
            font-size: 22px;
            margin-top: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        h3 {
            margin: 0;
        }


        #result {
            font-size: 1em;
            font-weight: bold;
            color: rgb(149, 27, 27);
            margin-top: 0;
            margin-bottom: 15px;
        }

        #resultsTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
            text-align: right;
            display: none;
        }

        #resultsTable th,
        #resultsTable td {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        #resultsTable th {
            text-align: center;
            background-color: #007BFF;
            color: white;
            font-weight: normal;
        }

        #resultsTable tbody tr:nth-child(even) {
            background-color: #e6e6e6;
        }

        /* --- –°—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (Pop-up) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            color: #333;
        }

        .modal-content.neumorphic-modal {
            background-color: #f0f0f0;
            box-shadow: 10px 10px 20px rgba(163, 163, 163, 0.4), -10px -10px 20px rgba(255, 255, 255, 0.8);
        }

        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 5px 5px 10px rgba(163, 163, 163, 0.4), -5px -5px 10px rgba(255, 255, 255, 0.8);
        }

        .modal-buttons button:first-child {
            background-color: #dc3545;
            color: white;
        }

        .modal-buttons button:last-child {
            background-color: #f0f0f0;
            color: #333;
        }


        /* --- –¢–ï–ú–ù–ê–Ø –¢–ï–ú–ê (DARK MODE Neumorphism) --- */
        body.dark-mode {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }

        body.dark-mode .container {
            background-color: #1e1e1e;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.4),
                -10px -10px 20px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode .form-input,
        body.dark-mode .form-select {
            background-color: #1e1e1e;
            color: #e0e0e0;
            box-shadow: inset 5px 5px 10px rgba(0, 0, 0, 0.4), inset -5px -5px 10px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode .form-input.input-error {
            border: 1px solid #ff6666;
            box-shadow: inset 2px 2px 5px #ff666666, inset -2px -2px 5px #ff666666;
        }

        body.dark-mode .form-input:disabled,
        body.dark-mode .form-select:disabled {
            background-color: #2c2c2c;
            color: #777;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.4), inset -2px -2px 5px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode .calculate-btn {
            background-color: #0056b3;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode .reset-btn {
            background-color: #a33b47;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode .share-btn {
            background-color: #1e7e34;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode #resultsTable th {
            background-color: #0056b3;
        }

        body.dark-mode #resultsTable tbody tr:nth-child(even) {
            background-color: #2c2c2c;
        }

        body.dark-mode #themeToggle {
            background-color: #2c2c2c;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode .main-title-link {
            color: #4da6ff;
        }

        body.dark-mode .result-title {
            color: #ffffff;
        }

        body.dark-mode .modal-content.neumorphic-modal {
            background-color: #1e1e1e;
            box-shadow: 10px 10px 20px rgba(0, 0, 0, 0.4), -10px -10px 20px rgba(60, 60, 60, 0.4);
            color: #e0e0e0;
        }

        body.dark-mode .modal-buttons button {
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.4), -5px -5px 10px rgba(60, 60, 60, 0.4);
        }

        body.dark-mode .modal-buttons button:last-child {
            background-color: #1e1e1e;
            color: #e0e0e0;
        }


        /* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø --- */
        @media (max-width: 500px) {
            body {
                padding-top: 10px;
            }

            .container {
                width: 90%;
                margin-left: auto;
                margin-right: auto;
            }

            #resultsTable thead tr th:nth-child(3),
            #resultsTable thead tr th:nth-child(4),
            #resultsTable tbody tr td:nth-child(3),
            #resultsTable tbody tr td:nth-child(4) {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="container" id="calculatorContainer">
        <button id="themeToggle" onclick="toggleTheme()"></button>

        <a href="javascript:void(0)" onclick="window.location.reload(); return false;" class="main-title-link">
            –†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ <br> –Ω–∞–º–æ—Ç–æ—á–Ω—ã—Ö —Ä—É–ª–æ–Ω–æ–≤ –∏ –æ—Å—Ç–∞—Ç–∫–∞
        </a>

        <div class="underlined-title"><span class="text-underline">–ú–∞—Ç–æ—á–Ω—ã–π —Ä—É–ª–æ–Ω</span></div>
        <label for="distanceToEdge" class="form-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —à–ø—É–ª–∏ –¥–æ –≤–Ω–µ—à–Ω–µ–≥–æ –∫—Ä–∞—è —Ñ–æ–ª—å–≥–∏ (–º–º):</label>
        <input type="number" id="distanceToEdge" class="form-input">

        <div class="checkbox-container">
            <input type="checkbox" id="useRupture" onchange="toggleRuptureField()" class="form-input-checkbox">
            <label for="useRupture" class="form-label">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–æ –ø–æ—Ä—ã–≤–∞</label>
        </div>
        <label for="distanceToRupture" class="form-label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —à–ø—É–ª–∏ –¥–æ –ø–æ—Ä—ã–≤–∞ (–º–º):</label>
        <input type="number" id="distanceToRupture" disabled class="form-input">
        <label for="masterCore" class="form-label">–î–∏–∞–º–µ—Ç—Ä —à–ø—É–ª–∏ –º–∞—Ç–æ—á–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞ (–º–º):</label>
        <input type="number" id="masterCore" value="660" class="form-input">

        <div class="underlined-title"><span class="text-underline">–ù–∞–º–æ—Ç–æ—á–Ω—ã–π —Ä—É–ª–æ–Ω</span></div>
        <label for="targetOuter" class="form-label">–ö–æ–Ω–µ—á–Ω—ã–π (–Ω–æ–º–∏–Ω–∞–ª—å–Ω—ã–π) –¥–∏–∞–º–µ—Ç—Ä –Ω–∞–º–æ—Ç–æ—á–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞ (–º–º):</label>
        <input type="number" id="targetOuter" class="form-input">

        <label for="targetCoreSelector" class="form-label">–î–∏–∞–º–µ—Ç—Ä –Ω–∞–º–æ—Ç–æ—á–Ω–æ–π —à–ø—É–ª–∏ (–º–º):</label>
        <select id="targetCoreSelector" class="form-select">
            <option value="81.2">81.2 (–≤–Ω. –¥–∏–∞–º–µ—Ç—Ä 76.2 + —Å—Ç–µ–Ω–∫–∞ 2.5)</option>
            <option value="158.4">158.4 (–≤–Ω. –¥–∏–∞–º–µ—Ç—Ä 152.4 + —Å—Ç–µ–Ω–∫–∞ 3)</option>
        </select>

        <label for="densityCorrection" class="form-label correction-label">
            <span class="text-underline">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏</span>
        </label>
        <input type="number" id="densityCorrection" value="1.0" step="0.01" class="form-input">

        <button class="calculate-btn" onclick="calculateRolls()">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</button>

        <button class="reset-btn" onclick="showResetConfirmation()">–°–±—Ä–æ—Å–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>

        <h2 class="result-title">–†–µ–∑—É–ª—å—Ç–∞—Ç:</h2>
        <p id="result">–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.</p>

        <table id="resultsTable">
            <thead>
                <tr>
                    <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—É–ª–æ–Ω–æ–≤ (—à—Ç)</th>
                    <th>–¢–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç)</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —à–ø—É–ª–µ –ø–µ—Ä–µ–¥ —Ä–µ–∑–∫–æ–π (–º–º)</th>
                    <th>–û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —à–ø—É–ª–µ –ø–æ—Å–ª–µ —Ä–µ–∑–∫–æ–π (–º–º)</th>
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>

        <button class="share-btn" id="shareResultBtn" onclick="shareResults()">
            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (Telegram/WhatsApp)
        </button>


        <div id="confirmationModal" class="modal">
            <div class="modal-content neumorphic-modal">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è –≤–≤–æ–¥–∞?</p>
                <div class="modal-buttons">
                    <button onclick="resetForm(true)">–î–∞</button>
                    <button onclick="resetForm(false)">–ù–µ—Ç</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –î–õ–Ø –•–†–ê–ù–ï–ù–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ---
        let latestResults = null;

        // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –¢–ï–ú–´ ---
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const themeButton = document.getElementById('themeToggle');

            if (body.classList.contains('dark-mode')) {
                themeButton.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            } else {
                themeButton.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            }
        }

        window.onload = function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                toggleTheme();
            } else {
                document.getElementById('themeToggle').textContent = 'üåô';
            }
        }
        // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–ï–ú–´ ---

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ---
        function formatNumberForDisplay(num, decimalPlaces = 1) {
            if (isNaN(num) || !isFinite(num)) return '‚Äî';

            const fixedString = num.toFixed(decimalPlaces);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —á–∏—Å–ª–æ, –∞ –Ω–µ —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö –Ω—É–ª–µ–π (.0)
            return decimalPlaces === 0 ? parseInt(fixedString) : parseFloat(fixedString);
        }
        // --- –ö–û–ù–ï–¶ –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ô –§–£–ù–ö–¶–ò–ò –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–Ø ---

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–õ–ê–°–°–û–ú –û–®–ò–ë–ö–ò ---
        function toggleErrorClass(elementId, isValid) {
            const element = document.getElementById(elementId);
            if (element) {
                if (isValid) {
                    element.classList.remove('input-error');
                } else {
                    element.classList.add('input-error');
                }
            }
        }

        // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–õ–ï–ú –ü–û–†–´–í–ê ---
        function toggleRuptureField() {
            const useRuptureCheckbox = document.getElementById('useRupture');
            const distanceToRuptureInput = document.getElementById('distanceToRupture');

            if (useRuptureCheckbox.checked) {
                distanceToRuptureInput.disabled = false;
            } else {
                distanceToRuptureInput.disabled = true;
                distanceToRuptureInput.value = '';
                toggleErrorClass('distanceToRupture', true);
            }
        }
        // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–õ–ï–ú –ü–û–†–´–í–ê ---


        // --- –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –†–ê–°–ß–ï–¢–ê ---
        function calculateRolls() {
            // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            latestResults = null;
            document.getElementById('shareResultBtn').style.display = 'none';

            // 1. –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –æ—à–∏–±–∫–∏
            const inputs = ['distanceToEdge', 'distanceToRupture', 'masterCore', 'targetOuter', 'densityCorrection'];
            inputs.forEach(id => toggleErrorClass(id, true));

            const distanceToEdge = parseFloat(document.getElementById('distanceToEdge').value);
            const distanceToRupture = parseFloat(document.getElementById('distanceToRupture').value);
            const useRupture = document.getElementById('useRupture').checked;
            const d_master = parseFloat(document.getElementById('masterCore').value);
            const D_target = parseFloat(document.getElementById('targetOuter').value);
            const d_target = parseFloat(parseFloat(document.getElementById('targetCoreSelector').value).toFixed(1));
            const K_correction = parseFloat(document.getElementById('densityCorrection').value);
            const resultElement = document.getElementById('result');
            const tableBody = document.getElementById('tableBody');
            const resultsTable = document.getElementById('resultsTable');

            resultElement.style.color = "red";
            resultsTable.style.display = "none";
            tableBody.innerHTML = '';

            let hasError = false;

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π –æ—à–∏–±–æ–∫

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ D_master (–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —à–ø—É–ª–∏ –¥–æ –≤–Ω–µ—à–Ω–µ–≥–æ –∫—Ä–∞—è) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–°–ï–ì–î–ê
            if (isNaN(distanceToEdge) || distanceToEdge <= 0) {
                toggleErrorClass('distanceToEdge', false);
                hasError = true;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ D_rupture (–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ø–æ—Ä—ã–≤–∞) - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û, –ï–°–õ–ò –í–ö–õ–Æ–ß–ï–ù –ß–ï–ö–ë–û–ö–°
            if (useRupture && (isNaN(distanceToRupture) || distanceToRupture <= 0)) {
                toggleErrorClass('distanceToRupture', false);
                hasError = true;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
            if (isNaN(d_master) || d_master <= 0) { toggleErrorClass('masterCore', false); hasError = true; }
            if (isNaN(D_target) || D_target <= 0) { toggleErrorClass('targetOuter', false); hasError = true; }
            if (isNaN(K_correction) || K_correction <= 0) { toggleErrorClass('densityCorrection', false); hasError = true; }


            if (hasError) {
                resultElement.textContent = "–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞: –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ —á–∏—Å–ª–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.";
                return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤–≤–æ–¥–∞
            }

            // 3. –†–∞—Å—á–µ—Ç—ã –≥–µ–æ–º–µ—Ç—Ä–∏–∏

            // –í–Ω–µ—à–Ω–∏–π –¥–∏–∞–º–µ—Ç—Ä –º–∞—Ç–æ—á–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞ (–¥–æ –ø–æ—Ä—ã–≤–∞), –Ω–∞ –æ—Å–Ω–æ–≤–µ distanceToEdge
            const D_master_initial = d_master + (2 * distanceToEdge);

            // –î–∏–∞–º–µ—Ç—Ä, –¥–æ –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –±—É–¥–µ–º –º–æ—Ç–∞—Ç—å (–æ–Ω –∂–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–∏–∞–º–µ—Ç—Ä —Ä–∞–±–æ—á–µ–≥–æ —Ä—É–ª–æ–Ω–∞)
            let D_master_final;

            if (useRupture) {
                // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Ä—ã–≤, –º–æ—Ç–∞–µ–º –¥–æ –¥–∏–∞–º–µ—Ç—Ä–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –ø–æ—Ä—ã–≤–æ–º
                D_master_final = d_master + (2 * distanceToRupture);

                if (D_master_final >= D_master_initial) {
                    resultElement.textContent = "–û—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏: –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ø–æ—Ä—ã–≤–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –¥–æ –≤–Ω–µ—à–Ω–µ–≥–æ –∫—Ä–∞—è —Ä—É–ª–æ–Ω–∞.";
                    toggleErrorClass('distanceToRupture', false);
                    return;
                }
            } else {
                // –ï—Å–ª–∏ –ø–æ—Ä—ã–≤–∞ –Ω–µ—Ç, –º–æ—Ç–∞–µ–º –¥–æ —Å–∞–º–æ–π —à–ø—É–ª–∏ (d_master)
                D_master_final = d_master;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ (–Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –ø–æ—Ä—ã–≤–∞)
            if (D_target <= d_target) {
                resultElement.textContent = "–û—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏: –ö–æ–Ω–µ—á–Ω—ã–π –¥–∏–∞–º–µ—Ç—Ä –Ω–∞–º–æ—Ç–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±–æ–ª—å—à–µ –¥–∏–∞–º–µ—Ç—Ä–∞ –Ω–∞–º–æ—Ç–æ—á–Ω–æ–π —à–ø—É–ª–∏.";
                toggleErrorClass('targetOuter', false);
                return;
            }
            if (D_master_initial < D_target) {
                resultElement.textContent = "–û—à–∏–±–∫–∞ –ª–æ–≥–∏–∫–∏: –ö–æ–Ω–µ—á–Ω—ã–π –¥–∏–∞–º–µ—Ç—Ä –Ω–∞–º–æ—Ç–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –≤–Ω–µ—à–Ω–∏–π –¥–∏–∞–º–µ—Ç—Ä –º–∞—Ç–æ—á–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞.";
                toggleErrorClass('targetOuter', false);
                toggleErrorClass('distanceToEdge', false);
                return;
            }

            // –ï—Å–ª–∏ –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –æ—à–∏–±–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
            resultElement.textContent = "";
            resultsTable.style.display = "table";
            resultElement.style.color = "initial"; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π


            // 4. –†–∞—Å—á–µ—Ç—ã –ø–ª–æ—â–∞–¥–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä—É–ª–æ–Ω–æ–≤

            // –ü–ª–æ—â–∞–¥—å –æ–¥–Ω–æ–≥–æ –Ω–∞–º–æ—Ç–æ—á–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞ (—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)
            const areaTargetBase = Math.pow(D_target, 2) - Math.pow(d_target, 2);
            const adjustedAreaTarget = areaTargetBase / K_correction;

            // –û–±—â–∞—è —Ä–∞–±–æ—á–∞—è –ø–ª–æ—â–∞–¥—å, –¥–æ—Å—Ç—É–ø–Ω–∞—è –¥–ª—è –Ω–∞–º–æ—Ç–∫–∏ (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É D_initial –∏ D_final)
            const areaMasterTotal = Math.pow(D_master_initial, 2) - Math.pow(D_master_final, 2);

            let areaRemainingMaster = areaMasterTotal;
            let fullRollsCount = 0;

            while (areaRemainingMaster >= adjustedAreaTarget) {
                fullRollsCount++;
                areaRemainingMaster -= adjustedAreaTarget;
            }

            const totalRollsExactInitial = areaMasterTotal / adjustedAreaTarget;

            // 5. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            const tableData = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º —Ç–∞–±–ª–∏—Ü—ã –∏ —à–µ—Ä–∏–Ω–≥–æ–º

            if (fullRollsCount === 0) {
                const row = tableBody.insertRow();
                const cell1 = row.insertCell(0);
                const cell2 = row.insertCell(1);
                const cell3 = row.insertCell(2);
                const cell4 = row.insertCell(3);

                const exactCountDisplay = formatNumberForDisplay(totalRollsExactInitial, 2);
                const distanceEdgeDisplay = formatNumberForDisplay(distanceToEdge, 1);

                cell1.textContent = '0';
                cell2.textContent = exactCountDisplay;
                cell3.textContent = distanceEdgeDisplay;
                cell4.textContent = '‚Äî';

                tableData.push({
                    count: 0,
                    exact: exactCountDisplay,
                    before: distanceEdgeDisplay,
                    after: '‚Äî'
                });

            } else {
                for (let i = fullRollsCount; i > 0; i--) {
                    const row = tableBody.insertRow();

                    const rollsAlreadyMade = fullRollsCount - i;
                    const currentExactRemaining = totalRollsExactInitial - rollsAlreadyMade;

                    // –†–∞—Å—á–µ—Ç –ø–ª–æ—â–∞–¥–∏ –∏ –¥–∏–∞–º–µ—Ç—Ä–∞ –î–û –Ω–∞–º–æ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ä—É–ª–æ–Ω–∞
                    const areaBeforeThisRoll = areaMasterTotal - (rollsAlreadyMade * adjustedAreaTarget);
                    const D_before = Math.sqrt(areaBeforeThisRoll + Math.pow(D_master_final, 2));
                    const remainingDistanceBefore = (D_before - d_master) / 2;

                    // –†–∞—Å—á–µ—Ç –ø–ª–æ—â–∞–¥–∏ –∏ –¥–∏–∞–º–µ—Ç—Ä–∞ –ü–û–°–õ–ï –Ω–∞–º–æ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Ä—É–ª–æ–Ω–∞
                    const areaAfterThisRoll = areaMasterTotal - ((rollsAlreadyMade + 1) * adjustedAreaTarget);
                    const D_after = Math.sqrt(areaAfterThisRoll + Math.pow(D_master_final, 2));
                    const remainingDistanceAfter = (D_after - d_master) / 2;

                    const countDisplay = i;
                    const exactDisplay = formatNumberForDisplay(currentExactRemaining, 2);
                    const beforeDisplay = formatNumberForDisplay(remainingDistanceBefore, 1);
                    const afterDisplay = formatNumberForDisplay(remainingDistanceAfter, 1);

                    const cell1 = row.insertCell(0);
                    const cell2 = row.insertCell(1);
                    const cell3 = row.insertCell(2);
                    const cell4 = row.insertCell(3);

                    cell1.textContent = countDisplay;
                    cell2.textContent = exactDisplay;
                    cell3.textContent = beforeDisplay;
                    cell4.textContent = afterDisplay;

                    tableData.push({
                        count: countDisplay,
                        exact: exactDisplay,
                        before: beforeDisplay,
                        after: afterDisplay
                    });
                }
            }

            // 6. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
            latestResults = {
                inputs: {
                    distanceToEdge: distanceToEdge,
                    distanceToRupture: useRupture ? distanceToRupture : null,
                    d_master: d_master,
                    D_target: D_target,
                    d_target: d_target,
                    K_correction: K_correction,
                    useRupture: useRupture,
                },
                tableData: tableData,
                fullRollsCount: fullRollsCount,
                totalRollsExactInitial: formatNumberForDisplay(totalRollsExactInitial, 2)
            };

            // –°—Ä–∞–∑—É –∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
            document.getElementById('shareResultBtn').style.display = 'block';
        }


        // --- –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –®–ï–†–ò–ù–ì–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ê –î–õ–Ø ANDROID/iOS) ---
        function shareResults() {
            if (!latestResults) {
                alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ä–∞—Å—á–µ—Ç.");
                return;
            }

            const { inputs, tableData, fullRollsCount, totalRollsExactInitial } = latestResults;

            // 1. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            let shareText = "üìä *–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ —Ä—É–ª–æ–Ω–æ–≤* üìä\n\n";
            shareText += `*–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:*\n`;
            shareText += `- –®–ø—É–ª—è –º–∞—Ç–æ—á–Ω–æ–≥–æ: ${inputs.d_master} –º–º\n`;
            shareText += `- –í–Ω–µ—à–Ω–∏–π –∫—Ä–∞–π: ${inputs.distanceToEdge} –º–º\n`;
            if (inputs.useRupture) {
                shareText += `- –î–æ –ø–æ—Ä—ã–≤–∞: ${inputs.distanceToRupture} –º–º\n`;
            }
            shareText += `- –î–∏–∞–º–µ—Ç—Ä –Ω–∞–º–æ—Ç–∫–∏: ${inputs.D_target} –º–º\n`;
            shareText += `- –®–ø—É–ª—è –Ω–∞–º–æ—Ç–∫–∏: ${inputs.d_target} –º–º\n`;
            shareText += `- –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ (K): ${inputs.K_correction}\n`;

            // 2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            shareText += "\n--- *–†–ï–ó–£–õ–¨–¢–ê–¢* ---\n";
            if (fullRollsCount > 0) {
                shareText += `‚úÖ *–ú–æ–∂–Ω–æ –Ω–∞–º–æ—Ç–∞—Ç—å ${fullRollsCount} —à—Ç.* (–¢–æ—á–Ω–æ: ${totalRollsExactInitial} —à—Ç.)\n`;

                // –ë–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –æ—Å—Ç–∞—Ç–∫—É –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞ (—ç—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –≤ –º–∞—Å—Å–∏–≤–µ, —Ç.–∫. —Ü–∏–∫–ª –æ–±—Ä–∞—Ç–Ω—ã–π)
                const finalRow = tableData[0] || {};

                shareText += `\n*–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ ${fullRollsCount} —à—Ç.:*\n`;
                shareText += `~ ${finalRow.after} –º–º (–æ—Ç —à–ø—É–ª–∏ ${inputs.d_master} –º–º)`;

            } else {
                shareText += `‚ùå *–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –Ω–∞–º–æ—Ç–∞—Ç—å –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ä—É–ª–æ–Ω–∞.* (–¢–æ—á–Ω–æ: ${totalRollsExactInitial} —à—Ç.)\n`;
                const finalRow = tableData[0] || {};
                shareText += `- –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∫—Ä–∞—è: ${finalRow.before} –º–º`;
            }

            // 3. –í—ã–∑–æ–≤ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ Web Share API (–û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö)
            if (navigator.share) {
                navigator.share({
                    title: '–†–∞—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ä—É–ª–æ–Ω–æ–≤',
                    text: shareText
                }).then(() => {
                    console.log('–ö–æ–Ω—Ç–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                }).catch((error) => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Web Share API (–≤–µ—Ä–æ—è—Ç–Ω–æ, –Ω–µ –Ω–∞ –º–æ–±.—É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ):', error);
                    // –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ –∏–ª–∏ —Å—Ç–∞—Ä—ã—Ö WebView
                    fallbackShare(shareText);
                });
            } else {
                // 4. –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–ø—Ä—è–º—ã–µ —Å—Å—ã–ª–∫–∏)
                fallbackShare(shareText);
            }
        }

        // --- –†–ï–ó–ï–†–í–ù–´–ô –®–ï–†–ò–ù–ì –î–õ–Ø –°–¢–ê–†–´–• –ë–†–ê–£–ó–ï–†–û–í/WEBVIEW/–î–ï–°–ö–¢–û–ü–ê ---
        function fallbackShare(text) {
            const encodedText = encodeURIComponent(text);

            // –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ/–≤–∫–ª–∞–¥–∫–µ
            const telegramLink = `https://t.me/share/url?url=&text=${encodedText}`;
            window.open(telegramLink, '_blank');

            // –¢–∞–∫–∂–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º WhatsApp (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –≤—ã–±–æ—Ä–æ–º, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø—Ä–æ—Å—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ–º Telegram)
            // const whatsappLink = `https://wa.me/?text=${encodedText}`;
            // window.open(whatsappLink, '_blank');
        }

        // --- –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–ù–û–ü–ö–ò –°–ë–†–û–°–ê –ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ---

        function showResetConfirmation() {
            const modal = document.getElementById('confirmationModal');
            modal.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        }

        function resetForm(confirmed) {
            const modal = document.getElementById('confirmationModal');
            modal.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ

            if (confirmed) {
                // –°–±—Ä–æ—Å –≤—Å–µ—Ö –ø–æ–ª–µ–π
                document.getElementById('distanceToEdge').value = '';
                document.getElementById('distanceToRupture').value = '';
                document.getElementById('useRupture').checked = false;

                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—è –ø–æ—Ä—ã–≤–∞
                toggleRuptureField();

                document.getElementById('masterCore').value = '660';
                document.getElementById('targetOuter').value = '';
                document.getElementById('targetCoreSelector').value = '81.2';
                document.getElementById('densityCorrection').value = '1.0';

                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –æ—à–∏–±–æ–∫
                const inputs = ['distanceToEdge', 'distanceToRupture', 'masterCore', 'targetOuter', 'densityCorrection'];
                inputs.forEach(id => toggleErrorClass(id, true));

                // –°–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
                document.getElementById('resultsTable').style.display = 'none';
                document.getElementById('tableBody').innerHTML = '';
                document.getElementById('shareResultBtn').style.display = 'none';

                document.getElementById('result').textContent = '–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞.';
                document.getElementById('result').style.color = "rgb(149, 27, 27)";

                latestResults = null; // –û—á–∏—â–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            }
        }

        window.onclick = function (event) {
            const modal = document.getElementById('confirmationModal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // --- –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –ö–ù–û–ü–ö–ò –°–ë–†–û–°–ê ---
    </script>
</body>

</html>